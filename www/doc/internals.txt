 DEVELOPER NOTE change before year 2036
 Instead of using tcl scan to convert times for detla t values,
 at least until 2036, hf_monitor_log.report_id is using machine time seconds.
 We can sanity check for machine time since the 
 list has already been sorted by time.
 And then subtract report_ids for faster, approximate delta t.



UI app procs in app-procs.tcl
hf_log_create (via batch process)
hf_log_read

UI batch processor API
hf::schedule::do
hf::schedule::add
hf::schedule::trash
hf::schedule::read
hf::schedule::list

General Asset UI in hosting-farm-asset-procs.tcl
hf_asset_id_exists 
hf_change_asset_id_for_label
hf_asset_rename
hf_asset_id_from_label 
hf_asset_label_from_id 
hf_asset_label_id_from_template_id 
hf_asset_from_label 
hf_asset_create 
hf_asset_stats 
hf_assets 
hf_asset_read 
hf_asset_write
hf_asset_delete
hf_asset_trash

The monitoring process

monitor batch processor API
hf::monitor::check
hf::monitor::do
hf::monitor::add
hf::monitor::trash
hf::monitor::read
hf::monitor::list



hosting-farm-local-ex-procs.tcl:ad_proc -private hfl_allow_q
hosting-farm-local-ex-procs.tcl:ad_proc -private hfl_asset_halt_example

hosting-farm-procs.tcl:ad_proc -private hf_vm_quota_read

monitoring processes are automatically considered periodic, and added using hf::monitor::add

monitor user API:
hf_monitor_configs_write
hf_monitor_configs_read
hf_monitor_logs
hf_monitors_inactivate


A process is called to add to the monitor_log


hf_monitor_update updates table hf_monitor_log

hf_monitor_status returns most recent analyzed monitor_logs from table hf_monitor_status

hf_monitor_statistics analyzes data from unprocessed hf_monitor_update, posts to hf_monitor_status, hf_monitor_freq_dist_curves, and hf_monitor_statistics

hf_monitor_report_read



#   hf_monitor_update         Write an update to a log (this includes distribution curve info, ie time as delta-t)
#   hf_monitor_status         Read status of asset_id, defaults to most recent status (like read, just status number)

#   hf_monitor_statistics     Analyse most recent hf_monitor_update in context of distribution curve
#                             Returns distribution curve of most recent configuration (table hf_monitor_freq_dist_curves)
#                             Save an Analysis an hf_monitor_update (or FLAG ERROR)

#   hf_monitor_logs           Returns monitor_ids of logs indirectly associated with an asset (direct is 1:1 via asset properties)

#   hf_monitor_report         Returns a range of monitor history
#   hf_monitor_status_history  Returns a range of status history

#   hf_monitor_asset_from_id  Returns asset_id of monitor_id





# hf_monitor_alert_create 
# hf_monitor_alert_process
# hf_monitor_alerts_status
# hf_monitor_alert_trash 


ad_proc -private hf_customer_subsite_add {
    customer_id
    {instance_id ""}
    {user_id ""}
} {
    NOTES ONLY. DOES NOT WORK. Intended to Create a customer subsite. Mount subsite, forums, creates a support forum
    for an enterprise level of complexity.
} {
    # These are essentially notes for expanding package to allow
    # enterprise customers to have a dedicated subsite to help provide
    # flexible notifications and inter-organizational communications with ams assets
    # Much of this from openacs.org/forums/message-view?message_id=116231

    # get customer_abbrev as label, customer_name as name
    set subsite_id [site_node::instantiate_and_mount -node_name $label -package_name $name -package_key "acs-susite"]
    # This also creates rational segments "Members" and "Administrators"

    # To get the "Members" segment 
    set u_seg [db_string rel_seg_id_get {
        select segment_id
        from rel_segments
        where group_id = :app_grp
        and rel_type= 'membership_rel'
    } -default ""]
    # To  remove the create privilege (If this needs to be done)
    permission::revoke -party_id $u_seg \
        -object_id $comm_obj_id -privilege create

    # Get the "Administrators" segment
    set a_seg [db_string rel_seg_id_get {
        select segment_id
        from rel_segments
        where group_id = :app_grp
        and rel_type= 'admin_rel'
    } -default ""]


    # Do not inherit permissions from the main site
    permission::set_not_inherit -object_id $subsite_id
    # Get the subsite application group
    set app_grp [application_group::group_id_from_package_id \
                     -package_id $comm_obj_id]
    
    # Set subsite application group join_policy to "needs approval"
    db_dml update_join_policy {
        update groups
        set join_policy = 'needs approval'
        where group_id = :app_grp
    }
    # There is another location to set the join policy?
    # Oh well, for good measure...
    parameter::set_value -package_id $comm_obj_id \
        -parameter RegistrationRequiresApprovalP -value 1

    # Be sure to add the primary user_id as admin
    # Add a user in a role
    relation_add -member_state "approved" \
        $role $app_grp $member_id

    #  There's also:
    # Remove a user from a role
    relation_remove $rel_id
    return 0
}

